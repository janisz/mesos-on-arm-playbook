---
- hosts: armservers
  remote_user: root
  tasks:
    - name: Update repositories
      apt:
        update_cache: yes
    - name: Install a few utility tools.
      apt: name={{item}}
      with_items:
           - tar
           - wget
           - git
           - htop
    - name: Install the latest OpenJDK.
      apt:
        name: openjdk-8-jdk
    - name: Create simlink to Java for Jenkins.
      file:
        path: /home/jenkins/tools/java/jdk1.8.0_131/bin/
        state: directory
    - name: Create simlink to Java for Jenkins.
      file:
        src: /usr/bin/java
        dest: /home/jenkins/tools/java/jdk1.8.0_131/bin/java
        state: link
    - name: Install autotools (Only necessary if building from git repository).
      apt: name={{item}}
      with_items:
           - autoconf
           - libtool
    - name: Install other Mesos dependencies.
      apt: name={{item}}
      with_items:
          - build-essential
          - python-dev
          - python-six
          - python-virtualenv
          - libcurl4-nss-dev
          - libsasl2-dev
          - libsasl2-modules
          - maven
          - libapr1-dev
          - libsvn-dev
          - zlib1g-dev
    - name: Remove useless packages from the cache
      apt:
        autoclean: yes
    - name: Remove dependencies that are no longer required
      apt:
        autoremove: yes

    # https://gist.github.com/phillipuniverse/7721288
    - name: Install NTP
      apt:
        name: ntp
      tags: ntp
    - name: Copy over the NTP configuration
      template: src=etc/ntp.conf dest=/etc/ntp.conf
      notify:
        - restart ntp
        - force ntp update
      tags: ntp
    - name: Make sure NTP is started up
      service: name=ntp state=started enabled=yes
      tags: ntp

    # https://gist.github.com/rn/08d13b7ed30ab5fbde9a6dcaa24831ce
    - name: Install some common tools
      apt: name={{item}}
      with_items:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
      tags: docker
    - name: Add an Apt signing key, uses whichever key is at the URL
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
      tags: docker
    - name: "Add arm64 testing"
      apt_repository:
        repo: deb [arch=arm64] https://download.docker.com/linux/ubuntu xenial test
        state: present
      tags: docker
    - name: Install docker
      apt:
        name: docker-ce
        update_cache: yes
      tags: docker

    # https://reference.apache.org/committer/node-hosting
    - name: Create a jenkins group
      group:
        name: jenkins
    - name: Create a jenkins user
      user:
        name: jenkins
        groups:
          - jenkins
          - docker
    - name: Add in the jenkins ssh public key into the users ~/.ssh/authorized keys
      authorized_key:
        user: jenkins
        key: https://raw.githubusercontent.com/apache/infrastructure-puppet/deployment/modules/build_slaves/files/jenkins.pub

    - name: Create a developers group
      group:
        name: dev
    - name: Create a user
      user:
        name: janisz
        groups:
          - dev
          - docker
    - name: Add public key for the user
      authorized_key:
        user: janisz
        key: https://github.com/janisz.keys


  handlers:
    - name: restart ntp
      service:
        name: ntp
        state: restarted
    - name: force ntp update
      shell: "service ntp stop && service ntp start"
